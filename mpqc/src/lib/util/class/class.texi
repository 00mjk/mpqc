@c -*-texinfo-*-
@node The Class Library, The DescribedClass Class, , Top
@chapter The Class Library
@cindex Class Library

The class library provides abstract base classes, macros, and include
files that collectively provide a mechanism that allows programmers
to retrieve information about a class' name; parents; and default,
@code{StateIn}, and @code{KeyVal} constructors.  Also, a castdown
mechanism is provided.

@menu
* The DescribedClass Class:: The abstract base class describing classes.
* The ClassDesc Class:: Each DescribedClass has a ClassDesc instance.
* The DescribedClass Ref Macros:: References to DescribedClass objects.
@end menu

@c ---------------------------------------------------------------------

@node The DescribedClass Class, The ClassDesc Class, The Class Library, The Class Library
@section The DescribedClass Class
@clindex DescribedClass

Classes which need information about themselves and their relationship
to other classes to be available at runtime can obtain this ability by
virtually inheriting from @code{DescribedClass}.  This will provide the
class with the ability to query its name, query its version, and perform
safe castdown operations.  Furthermore, the class's static
@code{ClassDesc} can be obtained which permits several other operations.

The special nature of described classes require that the base class,
@code{DescribedClass}, cannot provide everything needed.  To assist the
user in setting up described classes several include files are provided.

The @code{DescribedClass} class has the following interface:
@table @code
@item virtual ClassDesc* class_desc()=0
This returns the unique pointer to the @code{ClassDesc} for the object.
This is declared and implemented in the declaration include files.

@item virtual void* _castdown(ClassDesc*)=0
Given the @code{ClassDesc} for the class we wish to cast this class
into, this will perform the castdown and return a @code{void*} to the
appropiate subobject.  The function would not usually be used; it is
better to use the static @code{castdown} member to perform castdowns.
This function must be defined by the programmer.

@item char* class_name()
This returns a the name of the class.  The default implementation should
be adequate.

@item int class_version()
This returns the version number of the class.  The default
implementation should be adequate.
@end table

Additional members will appear in the interface of classes inheriting
@code{DescribedClass} because of the declaration include files.  These
additional members are:
@table @code
@item static DescribedClass* create_described_class()
This will create an instance of @code{DescribedClass} with exact type
@code{Client}.  The default constructor is used.

@item static Client* castdown(DescribedClass*p)
This will allow castdown operations from any @code{DescribedClass} to
@code{Client}.  If the castdown cannot be done, then 0 will be returned.

@item static ClassDesc* static_class_desc()
This returns the unique @code{ClassDesc} pointer for @code{Client}.
@end table

@c ---------------------------------------------------------------------

@node The ClassDesc Class, The DescribedClass Ref Macros, The DescribedClass Class, The Class Library
@section The ClassDesc Class
@clindex ClassDesc

This class is used to contain information about classes.  Each described
class has a static @code{ClassDesc} member.  This member has lists of
the parents, children and virtual parents for each class.  The
@code{ClassDesc} class also has a static member that is a list of all
described classes in the system.  These lists are constructed as the
constructors for the static @code{ClassDesc} members for each class are
called and are completed before @code{main} is entered.  The lists will
necessarily be incomplete or incorrect before @code{main} is entered so
programmers must be careful when using this information before
@code{main} is called.

The @code{ClassDesc} class has these members:
@table @code
@item const char* name() const
Returns the name of the class.

@item int version() const
Returns the version number of the class.

@item static ClassDesc* name_to_class_desc(const char*)
Given the name of the class, return a pointer to the class descriptor.

@item DescribedClass* create() const
Create an instance of @code{DescribedClass} with exact type equal to the
class to which this class descriptor belongs.  The constructor which
takes no arguments is used.  If this constructor doesn't exist or a
static function that calls it with @code{new} wasn't passed to this
@code{ClassDesc}, then @samp{0} will be returned.

@item DescribedClass* create(StateIn&) const
Create an instance of @code{DescribedClass} with exact type equal to the
class to which this class descriptor belongs.  The @code{StateIn&}
constructor is used (@pxref{The SavableState Library}).  If this
constructor doesn't exist or a static function that calls it with
@code{new} wasn't passed to this @code{ClassDesc}, then @samp{0} will be
returned.

@item DescribedClass* create(KeyVal&) const
Create an instance of @code{DescribedClass} with exact type equal to the
class to which this class descriptor belongs.  The @code{KeyVal&}
constructor is used (@pxref{The KeyVal Library}).  If this constructor
doesn't exist or
a static function that calls it with @code{new} wasn't passed to
this @code{ClassDesc}, then @samp{0} will be returned.

@item static void list_all_classes()
Writes a list of all of the classes to @code{stdout}.  This is useful
for debugging.

@item DescribedClass* create_described_class() const
This member has been replaced by @code{create()}.
@end table

@c ---------------------------------------------------------------------

@node The DescribedClass Ref Macros, , The ClassDesc Class, The Class Library
@section The DescribedClass Reference Macros
@mcindex DescribedClass_REF_dec
@mcindex DescribedClass_REF_def

The @code{DescribedClass} Reference Macros provide the memory management
facilities of the standard Reference Macros (@pxref{The Ref Library});
however, these macros provide new implementations of
constructor and assignment operators that take advantage of the
castdown ability of @code{DescribedClass}.  The standard reference
classes allows only assignment to references of the same exact type
or pointers of the same exact type of the contained object.  The
@code{DescribedClass} reference macros have constructor and assignment
operators that take @code{DescribedClass} references and pointers as
arguments.  They use the contained type's static @code{castdown}
operator to convert the target
@code{DescribedClass} object into an object of the same exact type.
If the cast fails a reference to null is assigned.

Here is an example:

@example
#include <util/class/class.h>

class A: virtual public DescribedClass {
 // all the stuff needed for a DescribedClass omitted
};
DescribedClass_REF_dec(A);

class B: public A {
 // all the stuff needed for a DescribedClass omitted
};
DescribedClass_REF_dec(B);

DescribedClass_REF_def(A);
DescribedClass_REF_def(B);

int
main()
{
  RefA a1(new B);
  RefB b1;

  // a1 and b1 will refer to the same object
  b1 = a1;

  RefA a2(new A)
  RefB b2;

  // b2 will refer to null since a2 does not refer to a B type object.
  b2 = a2;

  return 0;
}

@end example


