
\chapter{Compiling MPQC}
\index{compiling}
\index{installing}


These instructions are for a machine running Unix or Unix-like system. The
codes work under Linux, and AIX, at least.  The code has also be built
under MS Windows NT using the Cygnus development tools.

\section{Prerequisites}
 Make sure that you have the following programs available. Most can be
found at any GNU software FTP repository.
  \begin{itemize}

    \item Compilers for the C and C++ languages are needed.
       \begin{itemize}
           \item GNU gcc 2.7.2 or later works.  We highly recommend the GNU
               compiler which can be installed on many architectures.  It
               can be obtained by FTP from prep.ai.mit.edu.

           \item IBM xlC 3.1.3 or later works.

           \item SGI CC 6.0.1 and later.  Virtual base classes are broken
               in SGI's compiler and the configure script should
               automatically turn these off.  Give a target name to
               the configure script that contains the cpu model and
               OS minor number to get the right compiler options.
               For example, \type{configure r8000-sgi-irix6.0.1} or
               \type{configure r10000-sgi-irix6.2}.  The compiler
               might warn that some OPT limits need to be increased
               to fully optimize the code.  Increasing them won't
               make the code much faster, but the compile will be
               slower and use a great deal of memory.

       \end{itemize}

    \item Parts of GNU libg++ are needed.  It isn't necessary to link with
          libg++, but you need to have the genclass command in your path
          and it must be able to locate the prototype classes.  If you
          don't have GNU libg++, here is how to get the necessary parts
          without installing the whole thing:

       \begin{itemize}
          \item Get libg++-2.7.2.tar.gz by FTP from prep.ai.mit.edu and
                untar it.
          \item Move the libg++/src/gen directory to wherever you want it.
          \item Copy the libg++/genclass/genclass.sh shell script to
                somewhere in your path and name it ``genclass''.  Make
                it executable.
          \item Modify genclass so that PROTODIR points to your gen
                directory.
       \end{itemize}

    \item GNU flex (version 2.5.2 or greater): This is a lexical analyzer
          generator used to generate code to read input files. Make sure
          that FlexLexer.h from flex is in your include path. You may need
          to give the path to it to configure with an argument that looks
          something like: \type{--with-include=-I/usr/local/include}

    \item GNU bison (version 1.24 or greater): This is a parser generator used
          to generate code to read input files.

    \item GNU gmake (version 3.70 or greater): GNU specific extensions to make
          are used extensively.

    \item perl: This is used to convert template classes to macros,
          generate documentation, generate and check the validation suite
          etc.  To compile MPQC, either perl 4 or perl 5 will work.  To
          generate the validation inputs and automatically check the
          outputs, perl 5.003 is needed.

  \end{itemize}

\section{Configuration}

 You can optionally make a sister directory to \filnm{SC} which will be
used to hold all of the files generated by the compilation.  This directory
is usually named to indicate the architecture (e.g. \filnm{SC.i686-linux})
and will be referred to as the target directory below.

 In the target directory execute the "configure" command which is located
in the SC source directory. This command should build a hierarchy of
target directories and the necessary makefiles. Do a \type{configure
--help} to see a list of options.  Useful options to configure
include:

\begin{description}
\item[\type{--enable-debug}] Options for debugging will be given to
the compiler.
\item[\type{--disable-parallel}] Do not try to find communications
libraries.
\item[\type{--enable-ref-debug}] Check for overwrites and overflows
for reference counts.  Implied by ``--enable-debug''.
\item[\type{--disable-ref-macros}] Use template classes for reference
counting.  This doesn't work with any known compiler.  The default is to
use a CPP macro to generate a class definition.
\item[\type{--enable-cross-compile}] If this option is set then the
configure script will take care to not execute any compiled test programs.
\item[\type{--enable-shared-libs}] This will generate shared objects and
link with them instead of standard ``.a'' libraries.  This works on a
Linux-ELF system.
\item[\type{--with-cc}] Gives the name of the C compiler.
\item[\type{--with-cxx}] Gives the name of the C++ compiler.
\item[\type{--with-ranlib}] Gives the name of the archive indexing utility.
\item[\type{--with-ar}] Gives the name of the program than makes libraries.
\item[\type{--with-ld}] Gives the name of the object linker.
\item[\type{--with-include}] Gives directories in which include files
should be sought.  For example, \type{--with-include="-I/u/local/inc -I/u/cljanss/include"}
\item[\type{--with-libs}] Specifies libraries that executables should be
linked with.
\item[\type{--with-libdirs}] Gives the directories in which libraries
should be sought.
\end{description}

  If you would like to further customize your target directory,
you can edit \filnm{src/lib/config.h} and \filnm{lib/LocalMakefile} to
suit your needs.

\section{Compiling MPQC}

 First you need to generate several include files to satisfy
cross-dependencies between libraries.  Do this by changing into
your target directory and type \type{make interface}.  If you get error
messages in this step do a \type{make distclean} after correcting the
problem since there might be some incorrectly generated include or source
files remaining.

 Now you are ready to build the libraries and executable.  Do this
by typing \type{make} in your target directory.  All the libraries and
a single executable, \exenm{src/bin/mpqc/mpqc}, should be built.
If you are running on a symmetric multi-processor, you can use GNU
make to parallelize the compilation.  To compile four files at a time,
type \type{make JOBS=-j4}.

\section{Validating MPQC}

 After you compile MPQC, you should run it through the validation suite.
You should also run the validation suite if you upgrade your operating
system software, since this could change shared libraries that are linking
with MPQC and could affect the results.

 The validation suite is in \filnm{src/bin/mpqc/validate}.  The
input files are divided into several categories:
\begin{description}
  \item[\filnm{h2o}] These are simple tests that exercise many of MPQC's
        features.

  \item[\filnm{h2omp2}] Tests that further exercise MP2.

  \item[\filnm{mbpt}] These tests exercise MP2 as well as the open-shell
        perturbation theory methods.  The various available
        algorithms are tested as well.

  \item[\filnm{ckpt}] Tests the checkpoint and restart capabilities.

  \item[\filnm{symm1}] Tests of point group symmetry.

  \item[\filnm{symm2}] More point group symmetry tests.  These use basis
        sets with higher angular momentum than \filnm{symm1}.

  \item[\filnm{basis1}] A variety of basis sets are tested for first row
        atoms along with hydrogen and helium.

  \item[\filnm{basis2}] Basis sets test for second row atoms.

\end{description}

  To generate the input files change into the \filnm{src/bin/mpqc/validate}
subdirectory of your object directory (where you compiled MPQC) and type
\type{make inputs}.  This will create a \filnm{run} subdirectory containing
MPQC input files ending with the \filnm{.in} suffix.  Files ending with a
\filnm{.qci} suffix will also be placed in the \filnm{run} directory.
These contain a description of the calculation that is used by the utility
program that checks the results of the validation suite.

  Next you need to run the calculations.  You might want to start with the
\filnm{h2o} input files first since they shouldn't take too long to run.
For the \filnm{ckpt} calculations you should run the calculations
alphabetically by input file name.  This ensures that the checkpoint files
will be created before they are needed.

  While the test calculations are running you can begin monitoring the
results by typing \type{make checkrun} in the \filnm{src/bin/mpqc/validate}
directory.  This will first do some consistency checks between pairs of
files selected from the \filnm{ckpt}, \filnm{mbpt}, \filnm{symm1}, and
\filnm{symm2} groups of calculations (see below for a discussion of the
output for comparison of two files).  Then each file is individually
checked.  An \type{ok} is printed next the test name, if it looks like the
calculation made it to the end.  A \type{missing} means the output file
could not be found.  A \type{failed} means that the output file has
problems (or the calculation may still be running).

  Next you will want to see if your compiled MPQC produces the same answer
as ours.  Note that we don't say ``the correct answer'' here, because our
reference validation suite has not been verified relative to a independent
code, except for a few spot checks.  If you find that MPQC doesn't produce
the same answer as another quantum chemistry program that you trust, then
please promptly notify us and send all the details.  The reference
validation suite is distributed separately from MPQC.  Obtain it (hopefully
it is available where you got the source code) and untar it in the
\filnm{src/bin/mpqc/validate} subdirectory of your MPQC object code
directory.  This will create the \filnm{ref} subdirectory.  Now you can
type \type{make check} and outputs in the \filnm{ref} and \filnm{run}
directories will be pairwise compared.

  When files are pairwise compared first the status (\type{ok},
\type{missing}, or \type{failed}) for each file is printed.  If both
statuses are \type{ok} then an \type{E:} is printed followed by the number
of digits to which the energies agree.  If they agree to all digits
\type{99} is printed.  If a gradient was computed, then \type{Grad:} is
printed followed by the number of digits to which the gradients in least
agreement agree.  Likewise if frequencies were computed.

  If two numbers do not agree to the expected accuracy, then an asterisk,
\type{*}, is printed after the number of digits in agreement.  There are a
few cases where a \type{*} might appear, but the calculations do agree.
These situations arise where there are degenerate orbitals and the
quantities compared depend on the choice of the orbitals.  This will never
happen for physical observables, like the energy and its derivatives;
however, it can happen for the quantities printed with the labels
\type{|S2|1}, \type{|S2|i}, \type{S2L}, and \type{D1L} in the \type{symm1}
test series.


  Finally, you can do a detailed comparison of the contents of the
\type{ref} and \type{run} subdirectories by typing \type{make diff}.

