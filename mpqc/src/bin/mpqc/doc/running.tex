
\chapter{Running MPQC}
\label{running mpqc}
\index{running MPQC}

MPQC runs on Linux workstations, Silicon Graphics computers,
and more.

\section{Command Line Options}

  MPQC recognizes the following command line options:

\begin{description}
\item[{\ttfamily -f}] The name of the input file.  The default is
                     {\ttfamily mpqc.in}.
\item[{\ttfamily -messagegrp}] A \clsnmref{ParsedKeyVal} specification of a
                      \clsnmref{MessageGrp} \htmlref{object}{pkvobject}.
                      The default depends on how MPQC was compiled.
\item[{\ttfamily -threadgrp}] A \clsnmref{ParsedKeyVal} specification of a
                      \clsnmref{ThreadGrp} \htmlref{object}{pkvobject}.
                      The default depends on how MPQC was compiled.
\item[{\ttfamily -l}] Sets a limit on the number of basis functions.
                     The default is zero, which means an unlimited number
                     of basis functions.
\item[{\ttfamily -W}] Sets the working directory.  The default is the
                      current directory.
\item[{\ttfamily -c}] Check the input and exit.
\item[{\ttfamily -v}] Print the version number.
\item[{\ttfamily -w}] Print the warranty information (there is no
                      warranty).
\item[{\ttfamily -d}] If a debugger object was given in the input
                      start the debugger running as soon as MPQC
                      is started.
\item[{\ttfamily -h}] Print a list of options.
\end{description}

\section{Environmental Variables}

MPQC looks at four environmental variables to set up
communication and find library files.  Other libraries
and utilities to run programs in parallel might look
at other environment variables as well.  The four that
apply on all platforms are:

\begin{description}
\item[{\ttfamily SCLIBDIR}] The name of the library directory.  The default
                      is the directory in the source distribution.  See the
                      \clsnmref{GaussianBasisSet} class documentation and
                      look below for more information.
\item[{\ttfamily MESSAGEGRP}] A \clsnmref{ParsedKeyVal} specification of a
                      \clsnmref{MessageGrp} \htmlref{object}{pkvobject}.
                      The default depends on how MPQC was compiled.  See
                      the \clsnmref{MessageGrp} class documentation for
                      more information.
\item[{\ttfamily MEMORYGRP}] A \clsnmref{ParsedKeyVal} specification of a
                      \clsnmref{MemoryGrp} \htmlref{object}{pkvobject}.
                      The default depends on how MPQC was compiled and the
                      \clsnmref{MessageGrp} in use.
\item[{\ttfamily THREADGRP}] A \clsnmref{ParsedKeyVal} specification of a
                      \clsnmref{ThreadGrp} \htmlref{object}{pkvobject}.
                      The default depends on how MPQC was compiled.
\end{description}

By default, MPQC tries to find basis set library files in
the source code distribution.  If the executable or source
code is moved, MPQC can be notified with the environmental
variable \verb|SCLIBDIR|.  In the source code distribution
this directory is \verb|SC/lib|.

For example if you need to run MPQC on a machine that doesn't
have the source code distribution in the same place as the
machine on which MPQC is compiled you must do the following
on the machine with the source code:

\begin{alltt}
cd SC/lib
tar cvf ../sclib.tar basis molinfo.ipv2
\end{alltt}

Then transfer \verb|sclib.tar| to the machine that you want to run
MPQC on and do something like

\begin{alltt}
mkdir ~/sclib
cd ~/sclib
tar xvf ../sclib.tar
setenv SCLIBDIR ~/sclib
\end{alltt}

The setenv command is specific to the C-shell.  You will need to
do what is appropriate for your shell.

The other three keywords specify objects.  This is done by
giving a mini \clsnmref{ParsedKeyVal} input in a string.  The
object is anonymous, that is, no keyword is associated with it.
Here is an example:

\begin{alltt}
setenv MESSAGEGRP "<\clsnmref{ShmMessageGrp}>:(n = 4)"
\end{alltt}

\section{Running MPQC on a Shared Memory Multiprocessor}
\index{computers!shared memory}
\index{shared memory}

By default, MPQC will run on only one CPU.  To specify more, you can give a
\clsnmref{ShmMessageGrp} \htmlref{object}{pkvobject} on the command line.
This would run mpqc in four processes:
\begin{alltt}
\exenm{mpqc} {\ttfamily -messagegrp "<\clsnmref{ShmMessageGrp}>:(n = 4)" -f} {\itshape input_file}
\end{alltt}

Alternately, the \clsnmref{ShmMessageGrp} \htmlref{object}{pkvobject} can
be given as an environmental variable:
\begin{alltt}
{\ttfamily setenv MESSAGEGRP "<\clsnmref{ShmMessageGrp}>:(n = 4)"}
\exenm{mpqc} {\ttfamily -f} {\itshape input_file}
\end{alltt}

If MPQC should unexpectedly die, shared memory segments and
semaphores will be left on the machine.  These should be promptly
cleaned up or other jobs may be prevented from running.  To
see if you have any of these resources allocated, use the
\verb|ipcs| command.  The output will look something
like:

\begin{alltt}
IPC status from /dev/kmem as of Wed Mar 13 14:42:18 1996
T     ID     KEY        MODE       OWNER    GROUP
Message Queues:
Shared Memory:
m 288800 0x00000000 --rw-------  cljanss     user
Semaphores:
s    390 0x00000000 --ra-------  cljanss     user
s    391 0x00000000 --ra-------  cljanss     user
\end{alltt}

To remove the IPC resources used by \verb|cljanss| in
the above example, type:

\begin{alltt}
ipcrm -m 288800
ipcrm -s 390
ipcrm -s 391
\end{alltt}

\section{Running MPQC on the Intel Paragon Running OSF}
\index{computers!Intel Paragon}
\index{Paragon}

To run interactively type:
\begin{alltt}
\exenm{mpqc} -sz {\itshape n_node} -f {\itshape input_file}
\end{alltt}

\section{Running MPQC on the IBM SP2}
\index{computers!IBM SP2}
\index{SP2}

The code is currently working on the
\htmladdnormallink{Maui SP2}{http://www.mhpcc.edu/}.
They have \htmladdnormallink{extensive information}{http://www.mhpcc.edu/}
on how to run on their SP2.

\subsection{Running Interactively}

The job is controlled by a group of environment variables.
Here are my current settings:
\begin{verbatim}
MP_CSS_INTERRUPT=YES
MP_HOSTFILE=NULL
MP_EUILIB=us
MP_EUIDEVICE=css0
MP_RMPOOL=0
MP_RESD=YES
MP_LABELIO=yes
MP_INFOLEVEL=1
MP_PGMMODEL=spmd
MP_PROCS=4
\end{verbatim}
The last variable, \verb|MP_NPROCS|, sets the number
of processors that will be used.

The program is run with the command:
\begin{alltt}
poe {\itshape executable} -f {\itshape inputfile}
\end{alltt}

\subsection{Using Load Leveler}

A load leveler script is needed to submit a command to the batch queue.
This specifies the queue (called class) and constraints on memory the
number of processors, etc.  The following template is a good start for
MPQC:

\begin{alltt}
#!/bin/sh
#@ environment = MessageGrp=MPIMessageGrp;\\
   MP_LANG=En_US;MP_LABELIO=YES;MP_INFOLEVEL=1;\\
   MP_PGMMODEL=spmd;MP_RESD=YES;MP_CSS_INTERRUPT=YES;\\
   MP_EUILIB=us
#@ input = /dev/null
#@ output = mpqc.out.$(Cluster).$(Process)
#@ error = mpqc.err.$(Cluster).$(Process)
#@ class = {\itshape CLASS}
#@ job_type = parallel
#@ min_processors = {\itshape MINPROC}
#@ max_processors = {\itshape MAXPROC}
#@ requirements =  (Adapter == "hps_user" && Memory >= {\itshape MEMORY})
#@ notification = complete
#@ notify_user = {\itshape EMAIL}
#@ shell = /bin/sh
#@ cpu_limit = {\itshape CPULIMIT}
#@ queue
/usr/lpp/poe/bin/poe {\itshape EXECUTABLE} -f {\itshape INPUTFILE}
\end{alltt}

To make the above useful, the italicized variables must be replaced.
Table~\ref{runningspvariables} explains the meaning of the variables:

\begin{table}
\caption{Variables Meanings for Sample IBM SP2 Loadleveler Script.}
\begin{center}
\begin{tabular}{lp{2.5in}c}
  \multicolumn{1}{c}{Variable}
     & \multicolumn{1}{c}{Meaning}
     & \multicolumn{1}{c}{Example} \\
  CLASS & queue name & small\_short \\
  MINPROC & minimum number of nodes & 4 \\
  MAXPROC & maximum number of nodes & 8 \\
  EMAIL & your email address & ynh@ude.edu \\
  CPULIMIT & maximum CPU time (hour:min:sec) & 1:0:0 \\
  MEMORY & maximum amount of memory (MBytes) & 64 \\
  EXECUTABLE & path to the executable & mpqc \\
  INPUTFILE & the input file name & mpqc.in \\
\end{tabular}
\end{center}
\label{runningspvariables}
\end{table}

The modified script is submitted with the following command:

\begin{alltt}
llsubmit {\itshape scriptname}
\end{alltt}

