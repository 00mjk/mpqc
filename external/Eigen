# -*- mode: cmake -*-

find_package(Eigen 3.1 REQUIRED)

# if found, try sanity check: try compiling a simple program
if (EIGEN_FOUND)
  set(Eigen_INCLUDE_DIR ${EIGEN_INCLUDE_DIR})
  # this only works if Eigen has been installed
  file(WRITE A.cxx "
    #include <Eigen/Core>
    #include <Eigen/Dense>
    #include <iostream>
    int main(int argc, char* argv[]){
      Eigen::MatrixXd m = Eigen::MatrixXd::Random(5, 5);
      Eigen::SelfAdjointEigenSolver<Eigen::MatrixXd> eig(m);
      Eigen::MatrixXd m_invsqrt = eig.operatorInverseSqrt();
      std::cout << m_invsqrt << std::endl;
    }
  ")
  try_compile(RES1 ${CMAKE_CURRENT_BINARY_DIR} ${CMAKE_CURRENT_SOURCE_DIR}/A.cxx CMAKE_FLAGS COMPILE_DEFINITIONS -I${Eigen_INCLUDE_DIR} OUTPUT_VARIABLE LOG1)
  if (NOT RES1)
    message("Eigen found at ${Eigen_INCLUDE_DIR} but failed sanity check:\n${LOG1}")
    set(EIGEN_FOUND FALSE)
  else()
    include_directories(${Eigen_INCLUDE_DIR})
  endif()
endif()

#if eigen not found or did not compile, use the built in
if (NOT EIGEN_FOUND)

  set(EXTERNAL_SOURCE_DIR ${PROJECT_SOURCE_DIR}/external)
  set(EXTERNAL_BUILD_DIR ${PROJECT_BINARY_DIR}/external/build)

  include(ExternalProject)

  set(EIGEN_URL https://bitbucket.org/eigen/eigen/get/3.1.3.tar.gz)
  set(EIGEN_URL_HASH MD5=dc4247efd4f5d796041f999e8774af04)

  if (EXISTS ${EXTERNAL_SOURCE_DIR}/eigen.tar.gz)
    set(EIGEN_URL ${EXTERNAL_SOURCE_DIR}/eigen.tar.gz)
    set(EIGEN_URL_HASH "")
    message(STATUS "Using Eigen archive ${EIGEN_URL}")
  endif()

  ExternalProject_Add(
    Eigen
    PREFIX ${EXTERNAL_BUILD_DIR}/Eigen
    URL ${EIGEN_URL}
    URL_HASH ${EIGEN_URL_HASH}
    CONFIGURE_COMMAND ""
    BUILD_COMMAND ""
    INSTALL_COMMAND
      ${CMAKE_COMMAND} -E copy_directory
      ${EXTERNAL_BUILD_DIR}/Eigen/src/Eigen/Eigen/
      ${EXTERNAL_BUILD_DIR}/Eigen/include/Eigen/
  )

  add_dependencies(External Eigen)
  set(Eigen_INCLUDE_DIR ${EXTERNAL_BUILD_DIR}/Eigen/include)
  include_directories(${Eigen_INCLUDE_DIR})
endif()

